"use strict";function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,r,t){return r&&_defineProperties(e.prototype,r),t&&_defineProperties(e,t),e}var _marked=regeneratorRuntime.mark(iterateRuleDeprecationWarnings);function _slicedToArray(e,r){return _arrayWithHoles(e)||_iterableToArrayLimit(e,r)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,r){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var t=[],n=!0,a=!1,i=void 0;try{for(var o,l=e[Symbol.iterator]();!(n=(o=l.next()).done)&&(t.push(o.value),!r||t.length!==r);n=!0);}catch(e){a=!0,i=e}finally{try{n||null==l.return||l.return()}finally{if(a)throw i}}return t}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var r=0,t=new Array(e.length);r<e.length;r++)t[r]=e[r];return t}}function ownKeys(r,e){var t,n=Object.keys(r);return Object.getOwnPropertySymbols&&(t=Object.getOwnPropertySymbols(r),e&&(t=t.filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})),n.push.apply(n,t)),n}function _objectSpread(r){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(t,!0).forEach(function(e){_defineProperty(r,e,t[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):ownKeys(t).forEach(function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(t,e))})}return r}function _defineProperty(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}var fs=require("fs"),path=require("path"),defaultOptions=require("../../conf/default-cli-options"),pkg=require("../../package.json"),ConfigOps=require("../shared/config-ops"),naming=require("../shared/naming"),ModuleResolver=require("../shared/relative-module-resolver"),_require=require("../linter"),Linter=_require.Linter,builtInRules=require("../rules"),_require2=require("./cascading-config-array-factory"),CascadingConfigArrayFactory=_require2.CascadingConfigArrayFactory,_require3=require("./config-array"),IgnorePattern=_require3.IgnorePattern,getUsedExtractedConfigs=_require3.getUsedExtractedConfigs,_require4=require("./file-enumerator"),FileEnumerator=_require4.FileEnumerator,hash=require("./hash"),LintResultCache=require("./lint-result-cache"),debug=require("debug")("eslint:cli-engine"),validFixTypes=new Set(["problem","suggestion","layout"]),internalSlotsMap=new WeakMap;function validateFixTypes(e){var r=!0,t=!1,n=void 0;try{for(var a,i=e[Symbol.iterator]();!(r=(a=i.next()).done);r=!0){var o=a.value;if(!validFixTypes.has(o))throw new Error('Invalid fix type "'.concat(o,'" found.'))}}catch(e){t=!0,n=e}finally{try{r||null==i.return||i.return()}finally{if(t)throw n}}}function calculateStatsPerFile(e){return e.reduce(function(e,r){return r.fatal||2===r.severity?(e.errorCount++,r.fix&&e.fixableErrorCount++):(e.warningCount++,r.fix&&e.fixableWarningCount++),e},{errorCount:0,warningCount:0,fixableErrorCount:0,fixableWarningCount:0})}function calculateStatsPerRun(e){return e.reduce(function(e,r){return e.errorCount+=r.errorCount,e.warningCount+=r.warningCount,e.fixableErrorCount+=r.fixableErrorCount,e.fixableWarningCount+=r.fixableWarningCount,e},{errorCount:0,warningCount:0,fixableErrorCount:0,fixableWarningCount:0})}function verifyText(e){var r=e.text,t=e.cwd,n=e.filePath,a=e.config,i=e.fix,o=e.allowInlineConfig,l=e.reportUnusedDisableDirectives,s=e.fileEnumerator,u=e.linter,c=n||"<text>";debug("Lint ".concat(c));var f="<text>"===c?path.join(t,c):c,g=u.verifyAndFix(r,a,{allowInlineConfig:o,filename:f,fix:i,reportUnusedDisableDirectives:l,filterCodeBlock:function(e){return s.isTargetPath(e)}}),p=g.fixed,d=g.messages,y=g.output,h=_objectSpread({filePath:c,messages:d},calculateStatsPerFile(d));return p&&(h.output=y),0<h.errorCount+h.warningCount&&void 0===h.output&&(h.source=r),h}function createIgnoreResult(e,r){var t=e.split(path.sep).find(function(e){return/^\./.test(e)}),n=r&&path.relative(r,e).startsWith("node_modules"),a=t?"File ignored by default.  Use a negated ignore pattern (like \"--ignore-pattern '!<relative/path/to/filename>'\") to override.":n?"File ignored by default. Use \"--ignore-pattern '!node_modules/*'\" to override.":'File ignored because of a matching ignore pattern. Use "--no-ignore" to override.';return{filePath:path.resolve(e),messages:[{fatal:!1,severity:1,message:a}],errorCount:0,warningCount:1,fixableErrorCount:0,fixableWarningCount:0}}function getRule(e,r){var t=!0,n=!1,a=void 0;try{for(var i,o=r[Symbol.iterator]();!(t=(i=o.next()).done);t=!0){var l=i.value.pluginRules.get(e);if(l)return l}}catch(e){n=!0,a=e}finally{try{t||null==o.return||o.return()}finally{if(n)throw a}}return builtInRules.get(e)||null}function iterateRuleDeprecationWarnings(r){var t,n,a,i,o,l,s,u,c,f,g,p,d,y,h;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=new Set,a=(t=[]).concat.apply(t,_toConsumableArray(r.map(getUsedExtractedConfigs))),o=!(i=!0),l=void 0,e.prev=5,s=a[Symbol.iterator]();case 7:if(i=(u=s.next()).done){e.next=28;break}c=u.value,f=0,g=Object.entries(c.rules);case 10:if(!(f<g.length)){e.next=25;break}if(p=_slicedToArray(g[f],2),d=p[0],y=p[1],n.has(d))return e.abrupt("continue",22);e.next=14;break;case 14:if(n.add(d),ConfigOps.getRuleSeverity(y)){e.next=17;break}return e.abrupt("continue",22);case 17:if((h=getRule(d,r))&&h.meta&&h.meta.deprecated){e.next=20;break}return e.abrupt("continue",22);case 20:return e.next=22,{ruleId:d,replacedBy:h.meta.replacedBy||[]};case 22:f++,e.next=10;break;case 25:i=!0,e.next=7;break;case 28:e.next=34;break;case 30:e.prev=30,e.t0=e.catch(5),o=!0,l=e.t0;case 34:e.prev=34,e.prev=35,i||null==s.return||s.return();case 37:if(e.prev=37,o)throw l;e.next=40;break;case 40:return e.finish(37);case 41:return e.finish(34);case 42:case"end":return e.stop()}},_marked,null,[[5,30,34,42],[35,,37,41]])}function isErrorMessage(e){return 2===e.severity}function getCacheFile(e,r){var t,n=path.normalize(e),a=path.resolve(r,n),i=n.slice(-1)===path.sep;function o(){return path.join(a,".cache_".concat(hash(r)))}try{t=fs.lstatSync(a)}catch(e){t=null}return t?t.isDirectory()||i?o():a:i?o():a}function toBooleanMap(e,i,r){if(e&&!Array.isArray(e))throw new Error("".concat(r," must be an array."));if(e&&0<e.length)return e.reduce(function(e,r){var t=_slicedToArray(r.split(":"),2),n=t[0],a=t[1];return"__proto__"!==n&&(e[n]=void 0===a?i:"true"===a),e},{})}function createConfigDataFromOptions(e){var r=e.ignorePattern,t=e.parser,n=e.parserOptions,a=e.plugins,i=e.rules,o=toBooleanMap(e.envs,!0,"envs"),l=toBooleanMap(e.globals,!1,"globals");return void 0!==o||void 0!==l||void 0!==r&&0!==r.length||void 0!==t||void 0!==n||void 0!==a||void 0!==i?{env:o,globals:l,ignorePatterns:r,parser:t,parserOptions:n,plugins:a,rules:i}:null}function directoryExists(e){try{return fs.statSync(e).isDirectory()}catch(e){if(e&&"ENOENT"===e.code)return!1;throw e}}var CLIEngine=function(){function f(e){_classCallCheck(this,f);var r=Object.assign(Object.create(null),defaultOptions,{cwd:process.cwd()},e);void 0===r.fix&&(r.fix=!1);var t,n,a=new Map,i=getCacheFile(r.cacheLocation||r.cacheFile,r.cwd),o=new CascadingConfigArrayFactory({additionalPluginPool:a,baseConfig:r.baseConfig||null,cliConfig:createConfigDataFromOptions(r),cwd:r.cwd,ignorePath:r.ignorePath,resolvePluginsRelativeTo:r.resolvePluginsRelativeTo,rulePaths:r.rulePaths,specificConfigPath:r.configFile,useEslintrc:r.useEslintrc}),l=new FileEnumerator({configArrayFactory:o,cwd:r.cwd,extensions:r.extensions,globInputPaths:r.globInputPaths,errorOnUnmatchedPattern:r.errorOnUnmatchedPattern,ignore:r.ignore}),s=r.cache?new LintResultCache(i):null,u=new Linter({cwd:r.cwd}),c=[o.getConfigArrayForFile()];internalSlotsMap.set(this,{additionalPluginPool:a,cacheFilePath:i,configArrayFactory:o,defaultIgnores:IgnorePattern.createDefaultIgnore(r.cwd),fileEnumerator:l,lastConfigArrays:c,lintResultCache:s,linter:u,options:r}),r.fix&&r.fixTypes&&0<r.fixTypes.length&&(debug("Using fix types ".concat(r.fixTypes)),validateFixTypes(r.fixTypes),t=new Set(r.fixTypes),n="function"==typeof r.fix?r.fix:function(){return!0},r.fix=function(e){var r=e.ruleId&&getRule(e.ruleId,c);return r&&r.meta&&t.has(r.meta.type)&&n(e)})}return _createClass(f,[{key:"getRules",value:function(){var l=internalSlotsMap.get(this).lastConfigArrays;return new Map(regeneratorRuntime.mark(function e(){var r,t,n,a,i,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield(builtInRules,"t0",1);case 1:t=!(r=!0),n=void 0,e.prev=4,a=l[Symbol.iterator]();case 6:if(r=(i=a.next()).done){e.next=12;break}return o=i.value,e.delegateYield(o.pluginRules,"t1",9);case 9:r=!0,e.next=6;break;case 12:e.next=18;break;case 14:e.prev=14,e.t2=e.catch(4),t=!0,n=e.t2;case 18:e.prev=18,e.prev=19,r||null==a.return||a.return();case 21:if(e.prev=21,t)throw n;e.next=24;break;case 24:return e.finish(21);case 25:return e.finish(18);case 26:case"end":return e.stop()}},e,null,[[4,14,18,26],[19,,21,25]])})())}},{key:"addPlugin",value:function(e,r){var t=internalSlotsMap.get(this),n=t.additionalPluginPool,a=t.configArrayFactory,i=t.lastConfigArrays;n.set(e,r),a.clearCache(),i.length=1,i[0]=a.getConfigArrayForFile()}},{key:"resolveFileGlobPatterns",value:function(e){var t=internalSlotsMap.get(this).options;if(!1===t.globInputPaths)return e.filter(Boolean);var r=(t.extensions||[".js"]).map(function(e){return e.replace(/^\./,"")}),n="/**/*.{".concat(r.join(","),"}");return e.filter(Boolean).map(function(e){var r=directoryExists(path.resolve(t.cwd,e))?e.replace(/[\/\\]$/,"")+n:e;return path.normalize(r).replace(/\\/g,"/")})}},{key:"executeOnFiles",value:function(e){var r=internalSlotsMap.get(this),t=r.cacheFilePath,n=r.fileEnumerator,a=r.lastConfigArrays,i=r.lintResultCache,o=r.linter,l=r.options,s=l.allowInlineConfig,u=l.cache,c=l.cwd,f=l.fix,g=l.reportUnusedDisableDirectives,p=[],d=Date.now();if(a.length=0,!u)try{fs.unlinkSync(t)}catch(e){var y=e&&e.code;if("ENOENT"!==y&&("EROFS"!==y||fs.existsSync(t)))throw e}var h,v=!0,b=!1,m=void 0;try{for(var C,x=n.iterateFiles(e)[Symbol.iterator]();!(v=(C=x.next()).done);v=!0){var w=C.value,P=w.config,_=w.filePath;if(w.ignored)p.push(createIgnoreResult(_,c));else{if(a.includes(P)||a.push(P),i){var F=i.getCachedLintResults(_,P);if(F){if(!(F.messages&&0<F.messages.length)||!f){debug("Skipping file since it hasn't changed: ".concat(_)),p.push(F);continue}debug("Reprocessing cached file to allow autofix: ".concat(_))}}var E=verifyText({text:fs.readFileSync(_,"utf8"),filePath:_,config:P,cwd:c,fix:f,allowInlineConfig:s,reportUnusedDisableDirectives:g,fileEnumerator:n,linter:o});p.push(E),i&&i.setCachedLintResults(_,P,E)}}}catch(e){b=!0,m=e}finally{try{v||null==x.return||x.return()}finally{if(b)throw m}}return i&&i.reconcile(),debug("Linting complete in: ".concat(Date.now()-d,"ms")),_objectSpread({results:p},calculateStatsPerRun(p),{get usedDeprecatedRules(){return h=h||Array.from(iterateRuleDeprecationWarnings(a))}})}},{key:"executeOnText",value:function(e,r,t){var n,a,i=internalSlotsMap.get(this),o=i.configArrayFactory,l=i.fileEnumerator,s=i.lastConfigArrays,u=i.linter,c=i.options,f=c.allowInlineConfig,g=c.cwd,p=c.fix,d=c.reportUnusedDisableDirectives,y=[],h=Date.now(),v=r&&path.resolve(g,r);return s.length=0,v&&this.isPathIgnored(v)?t&&y.push(createIgnoreResult(v,g)):(n=o.getConfigArrayForFile(v||"__placeholder__.js"),s.push(n),y.push(verifyText({text:e,filePath:v,config:n,cwd:g,fix:p,allowInlineConfig:f,reportUnusedDisableDirectives:d,fileEnumerator:l,linter:u}))),debug("Linting complete in: ".concat(Date.now()-h,"ms")),_objectSpread({results:y},calculateStatsPerRun(y),{get usedDeprecatedRules(){return a=a||Array.from(iterateRuleDeprecationWarnings(s))}})}},{key:"getConfigForFile",value:function(e){var r=internalSlotsMap.get(this),t=r.configArrayFactory,n=r.options,a=path.resolve(n.cwd,e);if(directoryExists(a))throw Object.assign(new Error("'filePath' should not be a directory path."),{messageTemplate:"print-config-with-directory-path"});return t.getConfigArrayForFile(a).extractConfig(a).toCompatibleObjectAsConfigFileContent()}},{key:"isPathIgnored",value:function(e){var r=internalSlotsMap.get(this),t=r.configArrayFactory,n=r.defaultIgnores,a=r.options,i=a.cwd,o=a.ignore,l=path.resolve(i,e);return(o&&t.getConfigArrayForFile(l).extractConfig(l).ignores||n)(l)}},{key:"getFormatter",value:function(e){var r=e||"stylish";if("string"!=typeof r)return null;var t=r.replace(/\\/g,"/"),n=internalSlotsMap.get(this),a=n?n.options.cwd:process.cwd();if(!naming.getNamespaceFromTerm(t)&&-1<t.indexOf("/"))o=path.resolve(a,t);else try{var i=naming.normalizePackageName(t,"eslint-formatter"),o=ModuleResolver.resolve(i,path.join(a,"__placeholder__.js"))}catch(e){o=path.resolve(__dirname,"formatters",t)}try{return require(o)}catch(e){throw e.message="There was a problem loading formatter: ".concat(o,"\nError: ").concat(e.message),e}}}],[{key:"getErrorResults",value:function(e){var t=[];return e.forEach(function(e){var r=e.messages.filter(isErrorMessage);0<r.length&&t.push(_objectSpread({},e,{messages:r,errorCount:r.length,warningCount:0,fixableErrorCount:e.fixableErrorCount,fixableWarningCount:0}))}),t}},{key:"outputFixes",value:function(e){e.results.filter(function(e){return Object.prototype.hasOwnProperty.call(e,"output")}).forEach(function(e){fs.writeFileSync(e.filePath,e.output)})}}]),f}();CLIEngine.version=pkg.version,CLIEngine.getFormatter=CLIEngine.prototype.getFormatter,module.exports={CLIEngine:CLIEngine,getCLIEngineInternalSlots:function(e){return internalSlotsMap.get(e)}};